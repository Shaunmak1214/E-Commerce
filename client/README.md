# Things the client-side has been built on
### Redux
- Redux forms the backbone for communicating with the rest API we have built on the back-end. 
- Whenever we need to get or post to our server we use **redux actions**.
- The response from the server is sent to the **redux reducer**. We receive this response as props in our components.
- All requests and responses are done in JSON format.
- There are mainly 4 states in our app : 
  - User - contains details of user and the signed in state
  - products - manages the entire product collection
  - Cart - contains all the info abt the user's cart
  - OrderHistory - contains the history of confirmed orders.
### Material UI
- Most of the material UI components have been integrated into this app. 
- A lot of styling to the material UI is provided by JSS (Css in JavaScript).
- You can refer to the [Material UI Documentation](https://material-ui.com/getting-started/usage/) for further explanation.
### Breakpoints
- CSS breakpoints are used all over the site to make it extremely responsive. 
 ```
  mb: "420px",
  sm: "640px",
  md: "768px",
  lg: "1024px",
  xl: "1280px",
```
### Cloudinary Service
Cloudinary is a cloud service to store our files online. We use that to store user images of products and users. The images we read from the system are sent to cloudinary using their api in a base64 encoded format. We extract the URLs from the response. These url are stored in our database.

# Structure
##### The project is well structured and organised for easy navigation.
#### The public folder contains our index.html. It contains a script provided by **Razor Pay** which is the payment gateway we use in our app.
### Src folder has all the components our app will use : 
- **Actions** contains the actions for redux store.
- **Assets** contains all the static files we use in different places.
- **Components** has those components which will be used everywhere in our app.
- **Containers** are the different routes our app will render.
- **hoc** are the higer order components which will wrap our app. Basically our app will be a child of these.
- **reducers** contains the different reducers for redux store.
- **styles** stores the main styles generated by tailwind CSS. Some components have their own styles as well. 
- **Widgets UI** contains all the re-useable components being used thoughout the app.

# HOCs
Higher order components are those which affect all routes in our app. They are never called from inside our code. Let's take a look at them.

## Layout
The layout is a functional higher order component. All our routes are passed as children to Layout which it then renders between a header and a footer.
```
<Layout>
  <Routes />
</Layout>
```

And our Layout returns this 
```
<Header />
  {props.children}
<Footer />
```
##### This structure gives the user a consistent feel while allowing him to navigate the website with utmost ease.

## Auth
The Auth hoc has just one job. To check with every route if the user has access or not. Every time we go to some link or refresh page, our component goes throuugh Auth HOC. 

**How it works**
- The Auth is a functional hoc. It receives the component we are about to render as a parameter.

- ```Auth(Composed Class, authUser, authAdmin)```

- As soon as some route is visited the Auth is called and an action is passed to redux store to get the auth details of the user. 
- The store sends a **GET** request to our server and receives a response with the details of the user if he is logged in or just an 

```{isAuth : false}```. 

- It then checks if the user is an admin or not. 
- Based on the above authorisation parameters it allows the user if he has access or redirects them to home page. In case the user is logged in but tried to access an admin route he is shown a Authorisation Revoked page.

##### The Auth hoc is the backbone of the security for our app and therefore very essential.

# Header
The Header handles a lot of functionalities - from logging in our user to navigating the whole site. I won't go much deep into logging in and sign up as thats mostly a part of the backend.

### Sidenav
- The sidenav is a part of Material UI's Sidenav Component.
- It's connected to the redux store to get the auth details of the user already stored in the user state of the store because of Auth hoc.
- There is a separate funcitonal component for sidenav items. This has three lists - no auth, user and for admin. 
- The sidenav items receives the auth details from sidenav and renders the list it deems fit.
- The Header passes sidenav props for toggling the log in and log out modals. 

### Forms 
- The forms have their own components. And they use the Input Widget which is custom made without the sue of material UI.
- The forms have been made to handle all kind of errors. All inputs are controlled.
- The inputs have their errors updated as they are filled in or blurred. 

#### Log In
- When the Log In form is submitted, it checks all the inputs for their errors.
- If they  all check out then the information is sent to the redux store which calls the log in api. 
- If the log in details match then we get a response like this 
```
isAuth : true,
id : user._id,
.
.
.
address : user.address
```
- If there is problem we get the appropriate response to display the error messages.

#### Sign Up
- Sign Up sends the user details to the server through an action through the redux store. 
- The server sends a mail regrading confirmation of the user.
- If mail is sent we receive `isAuth: false` as a response from the server. 
- If any error occurs we get appropriate response from the server.

### Cart
- The header is also connected by the cart state of redux. It only gets the number of items from the cart and displays it like a badge on the cart icon.

### The Header has a fixed position. The scrolling effect is done by adding a scroll event listener.

Also I have tried to make the header as responsive as possible. 

##### Creating a separate route for log in would have been more conveniant though.

# Home
The Home page is the first page as the site opens. As soon as the component is mounted a redux action is called to get a list of all the products from the database. Then a list of options is prepared which contains the titles and tags of the products. The first render then also sends another request to get 6 products based on the default filters. 

## The Home consists of a number of components
- Caraousel
- Search
- Products grid
- Filter

### Caraousel
This is a direct implementationn of the **React-Bootstrap Caraousel**. It renders 3 static images.

### Search
- This is a Widget which calls the autocomplete. Some custom JSS classes and the option list we prepared above is passed as props. This list is then alphabetically sorted for the user to easily find something they are looking for. 
- The search accepts an array of values which the user can enter by entering spaces or enter. 
- The search button sends this array and the other search filters to the redux store to get the filtered list of products. 
- The search bar is intended to always stay on the screen.
- The search is wrapped around a react-scrollmagic class which controls when the bar should go down or stay up. This changes according to the header appearing animation. 

### Product Grid
- The product grid is comprised of **Cards** from Material UI. The number of columns in the grid adjust with the screen width.
- The Card is another Widget that has the product images in a caraousel with the product details. 
- Each card has an action. Users can add the product to cart or the owners can directly edit the product.
- Each card is a link which takes the user to the product page.
- The *Add to cart* button sends as action to redux store with a the product Id which then sends the id to the server and we receive the new cart info in props as response.
- There is inifinite scrolling integrated into the home page. So more products load as the user scrolls to the bottom. 

This is done by adding a ref at the bottom of the page
```
<div ref={this.itemLoading}></div>
```
We initialize our scroll listner with scroll magic when the component has mounted
```
    new ScrollMagic.Scene({
      triggerElement: this.itemLoading.current,
      triggerHook: "onEnter",
    })
      .addTo(controller)
      .on("enter", () => this.handleOnScroll());
```
As soon as handleOnScroll is triggered a new request is sent to the server to get more products. We skip the origional item list but append the new items we get from the server in the actions with the already loaded list we pass as an argument to the redux action.
```
if (list) response.data.products = [...list, ...response.data.products];
      return response.data;
```

### Filter
The filter is a fixed position widget floating action button (FAB) from Material UI. It's got its own state by using React Hooks useState.
- The apply button verifies first if all the filters put by the user are valid and then sends the values to the Home and updates the main state.
- Then a redux action is sent with the updated filters which gets the new product list from the server.

# Product Page
The product page a query in the url in the form of a param which is accepted in the route
```
 <Route path="/product/:id" exact component={Auth(Product)} /> 
 /prdoduct/5f8c0b13e87fd9001740f631 
 props.params.id = 5f8c0b13e87fd9001740f631
``` 
- As soon as the page loads it sends an action to the redux store with the id we received in the url. 
- We receive the product details as the response which looks like this
```
{
  _id: productId,
  price,
  rating, 
  totalRating: The sum of all the ratings by users,
  title,
  quantity: stock,
  owner: details of the seller,
  userReviews: an array of all the comments on this product,
  imageURLs: an array of images for this product
}
```
- The logged in user's review is filtered from the list of reviews we get from the server.

This mainly consists of three containers 
- Image Caraousel
- Details
- Comment Section

### Image Caraousel
- Same carousel like home page except that it maps the images from the links in imageURLs from server. This caraousel is controlled.
- This component is pinned for widths greater than `sm breakpoint`. 
- Each image has a download button which will enable users to download a particular image.

### Details
- Prints the details in a flex box format.
- There is a button to the right of the title which copies the product URL.
- The quantity is not displayed plainly but its displayed in a stock based format.

### Comment Section
- It's divided into the My Review section and other reviews section.
- All comments are a child of the `<Fade></Fade>` component from **React-Reveal** and the comments are widgets where the information are passed as props.
- The comment widget will have a like and unlike button. By clicking either of them a request is sent to the server through redux initiating the like or dislike action.
- The rate review button will be sending the review of the user to the server.
- After every action the whole product gets updated. 

# Edit Product
The edit product page is quite simple. It makes use of the Input Widget from the Input UI folder. These are the material UI textfields. 
- The product id is received in the url as params. This is sent to the server through the redux store to get the product details.
- The styles are written in JSS and passed to these input as props. The errors in the fields are checked as the user types or the input goes out of focus and at the time of saving changes.
- The file input element is a widget with draggable event listeners. Refer to this [Medium article](https://medium.com/@650egor/simple-drag-and-drop-file-upload-in-react-2cb409d88929) for more info on how this works. I have made some changes to add some effects.
- Images are parsed in a base64 format through the file reader in java script.
- The origional state of the changes are stored in the props we receive from the server. So when we click the restore changes button the state of our app is set to the props.
- After making changes we can click save to send the details to the redux store. The base64 data of images is sent to cloudinary and the urls returned are sent to the server along with other details.

# Add Product
This page is built on the **Stepper** component of Material UI. The styles are written in JSS and passed to the stepper.
- There are 3 components in stepper
### Product Details
Different Inputs arranged using flex box for the product details. The tags input is a material UI Chip Input. Before going to the next step all inputs are verified.
### Product Images
This is file draggable block with grid layout with columns changing according to the width of the screen. All files are checked before being taken in. 
```
newFiles = newFiles.filter((file, i) => {
  if (types.includes(file.type) === false) {
    setError("Invalid file type discarded.");
    return false;
  }
  return true;
});

  if (files.length + newFiles.length > 12) {
    setError("Maximum 12 images allowed.");
    newFiles = newFiles.slice(0, 12 - files.length);
  }
```
### Confirm Product
This combines the above 2 components but all inputs are only readable. Clicking on confirm will send these new product details to server through the redux store.

# My Profile
We already have the user details in the redux store since all containers go through the Auth Hoc. 

All the changes to your profile are made as you edit them. Your image is updated as you change it. 

It's made of 3 components
### Image 
- The user's image is displayed through the url if the user has uploaded one or a default url if no url is found.
- When the pic is changed it is parsed in to base64 format and sent to the server through the redux store. 

### Address
- The address items are **address widgets** with details passed as props.
- The *edit* and *add address* buttons open the address editor widget. 
- On successfull addition, edit or deletion of an address the new user details are sent to the server through the redux store.

### Details
- All of user details are rendered in a flex column. 
- Whenever an input is blurred the input is verified and if its valid the new user details are sent to the server.

# Admin Panel
The admin panel authorisation is checked in the Auth HOC. Authorisation is checked through the role of the user
```
if (authAdmin === true && nextProps.user.user.role === 0)
  this.setState({ authRevoke: true });
```
- Before admin panel mounts, a request is sent to get the list of all the users from the database through the redux action.
- After we receive the list in our props, the list is divided into admin list and user list. 
- The lists are rendered in the form of two expandable accordions from Material UI.
- The users are rendered with a User Card widget. Depending on the screen size it has either a horizontal or vertical orientation.
- The add user option opens the sign up modal with extra props to suit admin addition. 
- When a user is added by admin a validated property is added to the object sent to the server so that no verification is required in the redux action.
```
 const request = await axios
  .post("/api/admin/addUser", { ...details, validated: true })
  .then((response) => response.data);
```
# Cart
- Before mount a request is sent through the redux store to get the current cart items of the user.
- The cart items are rendered through a widget **Cart Item** which utilizes **Card**  of material UI.
- The Cart Item widget changes orientation with width.
- When the quantity field is changed the cart in instantly updated by sending request to the server through redux store and receiving new cart in props.
- The payment button will initiate the payment only when cart items have no error.

# Payment
- Before mounting a request is made to the redux store to get the current cart items. 
- On receiving the cart items the total amount is calculated.
- Payment is done through Razor Pay. Before payment is made a new order request is made through axios directly to the api and not the redux store.
- After a payment is successfull a new payment id is generated by razor pay and we store these details in the order history of the user.
```
handler: async (response) => {
  this.setState({ loading: true });
  try {
    const paymentId = response.razorpay_payment_id;
    const url = `/api/capture`;
    const captureResponse = await Axios.post(url, {
      paymentId,
      amount: this.state.totalAmount,
    }).then((response) => {
      return response.data;
    });
```

# Dependencies

### Framework
- react
- react-dom
- react-router-dom
- react-redux
- react-router-navigation-prompt

### CSS 
- Material UI
- Tailwind CSS
- React-Bootstrap
- Material UI Chip Input
- Auto Prefixer
- PostCSS CLI
- PostCSS 
- RSuite
- Moment JS

### Animation
- React Transition Group
- React-Reveal
- Scroll Magic
- react-scroll-magic
- gsap

### Network and Requests
- axios
- HTTP-Proxy-Middleware
